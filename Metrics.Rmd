---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
metrics<- function(mydata){
  MB<- c(mean(-mydata$diff_mo_po,na.rm=T),
  mean(-mydata$diff_mo_ct))
  
  NMB<- c(sum(-mydata$diff_mo_po,na.rm=T)/sum(mydata$PM2.5),
  sum(-mydata$diff_mo_ct,na.rm=T)/sum(mydata$PM2.5))
  
  MAD<- c(median(abs(mydata$diff_mo_po),na.rm=T),
  median(abs(mydata$diff_mo_ct)))
  
  MR<- c(median(mydata$PM_grid/mydata$PM2.5,na.rm=T),
  median(mydata$Ens_pred/mydata$PM2.5,na.rm=T))
  
  RMSD<- c(sqrt(1/nrow(mydata)*sum((mydata$diff_mo_po)^2,na.rm=T)),
  sqrt(1/nrow(mydata)*sum((mydata$diff_mo_ct)^2,na.rm=T)))
  
  R2<- c(cor(mydata$PM_grid,mydata$PM2.5,use="complete.obs")^2,
  cor(mydata$Ens_pred,mydata$PM2.5,use="complete.obs")^2)
  
  ## Spatial and Temporal RMSD:
  Spatial<-aggregate(data=mydata,diff_mo_po~GEOID,FUN=mean)
  colnames(Spatial)<-c('GEOID','PM')
  Spatial.2<-aggregate(data=mydata,diff_mo_ct~GEOID,FUN=mean)
  colnames(Spatial.2)<-c('GEOID','PM')
  Spat.RMSD<- c(sqrt((1/(nrow(Spatial)))*(sum((Spatial$PM)^2))),
              sqrt((1/(nrow(Spatial.2)))*(sum((Spatial.2$PM)^2)))) 
   
  Temporal<-aggregate(data=mydata,diff_mo_po~date,FUN=mean)
  colnames(Temporal)<-c('date','PM')
  Temporal.2<-aggregate(data=mydata,diff_mo_ct~date,FUN=mean)
  colnames(Temporal.2)<-c('date','PM')
  Temp.RMSD<- c(sqrt((1/(nrow(Temporal)))*(sum((Temporal$PM)^2))),
                sqrt((1/(nrow(Temporal.2)))*(sum((Temporal.2$PM)^2))))
  
  ## Spatial and Temporal R^2:
  a<-aggregate(data=mydata,PM2.5~GEOID,FUN=mean)
  colnames(a)=c('GEOID','mo')
  b<-aggregate(data=mydata,Ens_pred~GEOID,FUN=mean)
  colnames(b)=c('GEOID','ct')
  c<-aggregate(data=mydata,PM_grid~GEOID,FUN=mean)
  colnames(c)=c('GEOID','po')
  spatial=merge(a,b,by=c('GEOID'))
  spatial=merge(spatial,c,by=c('GEOID'))
  mean_mo<-mean(spatial$mo)
  mean_ct<-mean(spatial$ct)
  mean_grid<-mean(spatial$po)
  Spat.R2<- c((sum((spatial$mo-mean_mo)*(spatial$po-mean_grid)))/(sqrt(sum((spatial$mo-mean_mo)^2)*(sum((spatial$po-mean_grid)^2)))),
             (sum((spatial$mo-mean_mo)*(spatial$ct-mean_ct)))/(sqrt(sum((spatial$mo-mean_mo)^2)*(sum((spatial$ct-mean_ct)^2)))))
  
  a<-aggregate(data=mydata,PM2.5~date,FUN=mean)
  colnames(a)=c('date','mo')
  b<-aggregate(data=mydata,Ens_pred~date,FUN=mean)
  colnames(b)=c('date','ct')
  c<-aggregate(data=mydata,PM_grid~date,FUN=mean)
  colnames(c)=c('date','po')
  temporal=merge(a,b,by=c('date'))
  temporal=merge(temporal,c,by=c('date'))
  mean_mo<-mean(temporal$mo)
  mean_ct<-mean(temporal$ct)
  mean_grid<-mean(temporal$po)
  Temp.R2<- c((sum((temporal$mo-mean_mo)*(temporal$po-mean_grid)))/(sqrt(sum((temporal$mo-mean_mo)^2)*(sum((temporal$po-mean_grid)^2)))),
              (sum((temporal$mo-mean_mo)*(temporal$ct-mean_ct)))/(sqrt(sum((temporal$mo-mean_mo)^2)*(sum((temporal$ct-mean_ct)^2)))))
  
  return(rbind(MB, NMB, MAD, MR, RMSD, R2, Spat.RMSD, Temp.RMSD, Spat.R2, Temp.R2))
  # Actually, these are spatial and temporal correlations, not R^2
}

```


```{r}
## Validation data set:
setwd("C:/Users/ellen/OneDrive/MyDocs/Graduate Research/Wildfire data project")
valid<- readRDS("Validation_set.rds")

round( cbind(metrics(valid), metrics(valid[which(valid$PM2.5 >= 12.1),]),
             metrics(valid[which(valid$PM2.5 >= 35.5),])), 2 )
             
```

```{r}
valid<-readRDS('/n/home02/haohaojy/monitor/portable/combine_clean_w.rds')
medium<- valid[which(valid$PM2.5 >= 12.1),] 
high<- valid[which(valid$PM2.5 >= 35.5),]

```

```{r}
# ## Get EPA (AQS) observations from training input:
# Reid_obs<- readRDS("PM25_inputs.rds")
# Reid_obs<- Reid_obs[,c("Lat", "Lon", "PM2.5_Obs", "Year", "Date_Local", 
#                 "Data_Source_Name_Display")]
# EPA<- str_detect(Reid_obs$Data_Source_Name_Display, "EPA")
# Reid_obs<- Reid_obs[EPA,]
# saveRDS(Reid_obs, "EPA_PM25_observations.rds")

## Using EPA combined data set from Jiayuan:
EPA<- readRDS("EPA_combine.rds")
EPA$diff_mo_ct=EPA$PM2.5-EPA$Ens_pred
EPA$diff_mo_po=EPA$PM2.5-EPA$PM_grid
EPA$diff=EPA$Ens_pred-EPA$PM_grid

EPA$GEOID<- paste0("0", EPA$state_id, "0", EPA$County_FIPS, EPA$Tract_code, "00")

epa<- round( cbind(metrics(EPA), metrics(EPA[which(EPA$PM2.5 >= 12.1),]),
             metrics(EPA[which(EPA$PM2.5 >= 35.5),])), 2 )

write.csv(epa, "EPA_compare_table.csv")

```
```{r}
## Function to use when we only have Reid data (for 2017 and 2018):

metrics_justReid<- function(mydata){
  MB<- mean(-mydata$diff_mo_ct)
  
  NMB<- sum(-mydata$diff_mo_ct,na.rm=T)/sum(mydata$PM2.5)
  
  MAD<- median(abs(mydata$diff_mo_ct))
  
  MR<- median(mydata$Ens_pred/mydata$PM2.5,na.rm=T)
  
  RMSD<- sqrt(1/nrow(mydata)*sum((mydata$diff_mo_ct)^2,na.rm=T))
  
  R2<- cor(mydata$Ens_pred,mydata$PM2.5,use="complete.obs")^2
  
  ## Spatial and Temporal RMSD:
  Spatial.2<-aggregate(data=mydata,diff_mo_ct~GEOID,FUN=mean)
  colnames(Spatial.2)<-c('GEOID','PM')
  Spat.RMSD<- sqrt((1/(nrow(Spatial.2)))*(sum((Spatial.2$PM)^2)))
  
  Temporal.2<-aggregate(data=mydata,diff_mo_ct~date,FUN=mean)
  colnames(Temporal.2)<-c('date','PM')
  Temp.RMSD<- sqrt((1/(nrow(Temporal.2)))*(sum((Temporal.2$PM)^2)))
  
  ## Spatial and Temporal R^2:
  a<-aggregate(data=mydata,PM2.5~GEOID,FUN=mean)
  colnames(a)=c('GEOID','mo')
  b<-aggregate(data=mydata,Ens_pred~GEOID,FUN=mean)
  colnames(b)=c('GEOID','ct')
  spatial=merge(a,b,by=c('GEOID'))
  mean_mo<-mean(spatial$mo)
  mean_ct<-mean(spatial$ct)
  
  Spat.R2<- (sum((spatial$mo-mean_mo)*(spatial$ct-mean_ct)))/(sqrt(sum((spatial$mo-mean_mo)^2)*(sum((spatial$ct-mean_ct)^2))))
  
  a<-aggregate(data=mydata,PM2.5~date,FUN=mean)
  colnames(a)=c('date','mo')
  b<-aggregate(data=mydata,Ens_pred~date,FUN=mean)
  colnames(b)=c('date','ct')
  temporal=merge(a,b,by=c('date'))
  mean_mo<-mean(temporal$mo)
  mean_ct<-mean(temporal$ct)
  
  Temp.R2<- (sum((temporal$mo-mean_mo)*(temporal$ct-mean_ct)))/(sqrt(sum((temporal$mo-mean_mo)^2)*(sum((temporal$ct-mean_ct)^2))))
  
  return(c(MB, NMB, MAD, MR, RMSD, R2, Spat.RMSD, Temp.RMSD, Spat.R2, Temp.R2))
  #Actually, these are spatial and temporal correlations, not R^2
}


```


```{r}

## Comparing Reid estimates in 2017 and 2018 to the validation data from those years:
valid<- readRDS("monitor_reid_1718.rds")

valid$diff_mo_ct=valid$PM2.5-valid$Ens_pred
valid$GEOID<- paste0("0", valid$state_id, "0", valid$County_FIPS, valid$Tract_code, "00")

reid_17.18<- round( cbind(metrics_justReid(valid), 
                          metrics_justReid(valid[which(valid$PM2.5 >= 12.1),]),
                          metrics_justReid(valid[which(valid$PM2.5 >= 35.5),])), 2 )

write.csv(reid_17.18, "Reid_17-18_compare.csv")

```




